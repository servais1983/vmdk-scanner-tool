/*
 * Règles YARA pour détecter les malwares courants
 * VMDKScanner
 */

rule Generic_Ransomware {
    meta:
        description = "Détection générique de ransomware"
        author = "VMDKScanner"
        severity = "high"
        date = "2023-01-01"

    strings:
        $ransom1 = "Your files have been encrypted" nocase
        $ransom2 = "All your files have been encrypted" nocase
        $ransom3 = "Your important files encryption produced" nocase
        $ransom4 = "send Bitcoin" nocase
        $ransom5 = "decrypt" nocase
        $ransom6 = "bitcoin" nocase
        $ransom7 = "payment" nocase
        $ransom8 = "recover your files" nocase
        $ransom9 = ".onion" nocase
        $ransom10 = "YOUR_FILES_ARE_ENCRYPTED" nocase
        $ransom11 = "your personal files are encrypted" nocase
        $ransom12 = "crypto" nocase

    condition:
        4 of ($ransom*)
}

rule Suspicious_PowerShell_Commands {
    meta:
        description = "Détection de commandes PowerShell suspectes"
        author = "VMDKScanner"
        severity = "medium"
        date = "2023-01-01"

    strings:
        $s1 = "Invoke-Expression" nocase
        $s2 = "IEX" nocase
        $s3 = "Invoke-WebRequest" nocase
        $s4 = "Net.WebClient" nocase
        $s5 = "DownloadString" nocase
        $s6 = "DownloadFile" nocase
        $s7 = "Start-BitsTransfer" nocase
        $s8 = "encodedcommand" nocase
        $s9 = "FromBase64String" nocase
        $s10 = "hidden" nocase
        $s11 = "WebClient" nocase

        $obf1 = { 73 65 74 2D 69 74 65 6D } // set-item
        $obf2 = { 69 6E 76 6F 6B 65 2D 65 78 70 72 65 73 73 69 6F 6E } // invoke-expression
        $obf3 = { 69 65 78 } // iex
        $obf4 = { 65 6E 63 6F 64 65 64 63 6F 6D 6D 61 6E 64 } // encodedcommand

        $imp1 = "Import-Module" nocase
        $imp2 = "ipmo" nocase
        $imp3 = "LoadModule" nocase

        $payload = "http" nocase
        $payload2 = "https" nocase

    condition:
        3 of ($s*) and (1 of ($payload*) or 2 of ($obf*) or 2 of ($imp*))
}

rule Linux_Backdoor {
    meta:
        description = "Détection de backdoors sur Linux"
        author = "VMDKScanner"
        severity = "high"
        date = "2023-01-01"

    strings:
        $s1 = "nc -l" nocase
        $s2 = "netcat -l" nocase
        $s3 = "socat" nocase
        $s4 = "mkfifo" nocase
        $s5 = "/dev/tcp/" nocase
        $s6 = "/dev/udp/" nocase
        $s7 = "bash -i >& /dev/tcp/" nocase
        $s8 = "0<&196;exec 196<>/dev/tcp/" nocase
        $s9 = "exec 5<>/dev/tcp/" nocase
        $s10 = "/bin/sh -i" nocase
        $s11 = "python -c 'import socket,subprocess,os" nocase
        $s12 = "perl -e 'use Socket" nocase
        $s13 = "rm -f backpipe; mknod backpipe p" nocase

    condition:
        2 of them
}

rule Suspicious_Windows_System_Modifications {
    meta:
        description = "Détection de modifications suspectes du système Windows"
        author = "VMDKScanner"
        severity = "medium"
        date = "2023-01-01"

    strings:
        $s1 = "REG ADD HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $s2 = "REG ADD HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $s3 = "New-ItemProperty -Path \"HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\"" nocase
        $s4 = "New-ItemProperty -Path \"HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\"" nocase
        $s5 = "schtasks /create" nocase
        $s6 = "New-ScheduledTask" nocase
        $s7 = "wmic /namespace:\\\\root\\subscription PATH __EventFilter" nocase
        $s8 = "wmic /namespace:\\\\root\\subscription PATH CommandLineEventConsumer" nocase
        $s9 = "wmic /namespace:\\\\root\\subscription PATH __FilterToConsumerBinding" nocase
        $s10 = "sc config" nocase
        $s11 = "New-Service" nocase
        $s12 = "bcdedit /set {default} bootstatuspolicy ignoreallfailures" nocase
        $s13 = "bcdedit /set {default} recoveryenabled no" nocase

    condition:
        3 of them
}

rule Cryptominer_Detection {
    meta:
        description = "Détection de logiciels de minage de cryptomonnaie"
        author = "VMDKScanner"
        severity = "medium"
        date = "2023-01-01"

    strings:
        $miner1 = "stratum+tcp://" nocase
        $miner2 = "--algo=" nocase
        $miner3 = "-o pool" nocase
        $miner4 = "-u wallet" nocase
        $miner5 = "xmrig" nocase
        $miner6 = "minerd" nocase
        $miner7 = "cpuminer" nocase
        $miner8 = "ethminer" nocase
        $miner9 = "bfgminer" nocase
        $miner10 = "cgminer" nocase
        $miner11 = "cryptonight" nocase
        $miner12 = "monero" nocase
        $miner13 = "ethereum" nocase

    condition:
        3 of them
}

rule BitLocker_Related_Files {
    meta:
        description = "Détection de fichiers liés à BitLocker"
        author = "VMDKScanner"
        severity = "info"
        date = "2023-01-01"

    strings:
        $s1 = "BitLocker" nocase
        $s2 = "FVE-FS" nocase
        $s3 = "FVEAPI.dll" nocase
        $s4 = "fvecpl.dll" nocase
        $s5 = "manage-bde" nocase
        $s6 = "recovery key" nocase

    condition:
        3 of them
}
